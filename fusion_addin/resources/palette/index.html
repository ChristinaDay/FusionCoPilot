
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Fusion 360 Co-Pilot</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #0696D7, #1E88E5);
            color: white;
            padding: 15px;
            margin: -10px -10px 20px -10px;
            border-radius: 0 0 8px 8px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .header p {
            margin: 5px 0 0 0;
            font-size: 12px;
            opacity: 0.9;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h3 {
            margin: 0 0 10px 0;
            color: #0696D7;
            font-size: 14px;
            font-weight: 600;
        }
        
        .prompt-input {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: inherit;
            font-size: 13px;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .prompt-input:focus {
            outline: none;
            border-color: #0696D7;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #0696D7;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0577B8;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .results-area {
            min-height: 120px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .action-log {
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 8px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-status {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .log-status.success {
            background-color: #28a745;
        }
        
        .log-status.error {
            background-color: #dc3545;
        }
        
        .log-status.pending {
            background-color: #ffc107;
        }
        
        .log-text {
            flex: 1;
            font-family: inherit;
        }
        
        .log-time {
            font-size: 10px;
            color: #6c757d;
            margin-left: 10px;
        }
        
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #343a40;
            color: white;
            padding: 8px 15px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0696D7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .example-prompts {
            margin-top: 10px;
        }
        
        .example-prompt {
            background-color: #e9ecef;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .example-prompt:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ Fusion 360 Co-Pilot</h1>
        <p>Natural Language ‚Üí CAD Operations</p>
    </div>
    
    <div class="section">
        <h3>üí¨ Natural Language Input</h3>
        <textarea id="promptInput" class="prompt-input" 
                  placeholder="Describe what you want to create...

Examples:
‚Ä¢ Create a 50x30mm plate that's 5mm thick
‚Ä¢ Add 4 corner holes, 6mm diameter, 5mm from edges
‚Ä¢ Fillet all edges with 2mm radius
‚Ä¢ Create a linear pattern of 5 holes spaced 10mm apart"></textarea>
        
        <div class="button-group">
            <button id="parseBtn" class="btn btn-primary">üîç Parse</button>
            <button id="previewBtn" class="btn btn-secondary" disabled>üëÅÔ∏è Preview</button>
            <button id="applyBtn" class="btn btn-success" disabled>‚úÖ Apply</button>
        </div>
        
        <div class="example-prompts">
            <div class="example-prompt" onclick="setPrompt('Create a 100x50x10mm rectangular plate')">
                üìê Create a 100x50x10mm rectangular plate
            </div>
            <div class="example-prompt" onclick="setPrompt('Add a 6mm hole in the center')">
                üï≥Ô∏è Add a 6mm hole in the center
            </div>
            <div class="example-prompt" onclick="setPrompt('Fillet all edges with 3mm radius')">
                üîÑ Fillet all edges with 3mm radius
            </div>
        </div>
    </div>
    
    <div class="section">
        <h3>üìã Plan Results</h3>
        <div id="resultsArea" class="results-area">Ready for input...</div>
    </div>
    
    <div class="section">
        <h3>üìù Action Log</h3>
        <div id="actionLog" class="action-log">
            <div class="log-entry">
                <div class="log-status success"></div>
                <div class="log-text">Co-Pilot initialized successfully</div>
                <div class="log-time">just now</div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div>
            <span class="spinner" id="loadingSpinner"></span>
            <span id="statusText">Ready</span>
        </div>
        <div>
            <button id="pingBtn" class="btn btn-secondary" style="padding:4px 8px;">Ping Fusion</button>
            <span id="connectionStatus">üü¢ Local Mode</span>
        </div>
    </div>
    
    <script>
        // Global state
        let currentPlan = null;
        let isProcessing = false;
        
        // DOM elements
        const promptInput = document.getElementById('promptInput');
        const parseBtn = document.getElementById('parseBtn');
        const previewBtn = document.getElementById('previewBtn');
        const applyBtn = document.getElementById('applyBtn');
        const resultsArea = document.getElementById('resultsArea');
        const actionLog = document.getElementById('actionLog');
        const statusText = document.getElementById('statusText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        
        // Event handlers
        parseBtn.addEventListener('click', handleParse);
        previewBtn.addEventListener('click', handlePreview);
        applyBtn.addEventListener('click', handleApply);
        document.getElementById('pingBtn').addEventListener('click', handlePing);
        
        function setPrompt(text) {
            promptInput.value = text;
            promptInput.focus();
        }
        
        function handleParse() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showMessage('Please enter a prompt describing what you want to create.', 'error');
                return;
            }
            
            setProcessing(true, 'Parsing natural language...');
            
            // Send message to Fusion add-in (new bridge first, legacy fallback)
            try {
                adsk.fusionSendData('parse', JSON.stringify({ action: 'parse', prompt: prompt }));
            } catch (e) {
                if (window.fusionJavaScriptHandler && typeof window.fusionJavaScriptHandler.handle === 'function') {
                    try { window.fusionJavaScriptHandler.handle('parse', JSON.stringify({ action: 'parse', prompt: prompt })); }
                    catch (err) { console.error('Legacy parse failed', err); showMessage('Bridge error (legacy).', 'error'); setProcessing(false); }
                } else {
                    showMessage('Fusion bridge not available.', 'error');
                    setProcessing(false);
                }
            }
        }
        
        function handlePreview() {
            if (!currentPlan) {
                showMessage('No plan available for preview. Parse a prompt first.', 'error');
                return;
            }
            
            setProcessing(true, 'Generating preview...');
            
            try {
                adsk.fusionSendData('preview', JSON.stringify({ action: 'preview', plan: currentPlan }));
            } catch (e) {
                if (window.fusionJavaScriptHandler && typeof window.fusionJavaScriptHandler.handle === 'function') {
                    try { window.fusionJavaScriptHandler.handle('preview', JSON.stringify({ action: 'preview', plan: currentPlan })); }
                    catch (err) { console.error('Legacy preview failed', err); showMessage('Bridge error (legacy).', 'error'); setProcessing(false); }
                } else {
                    showMessage('Fusion bridge not available.', 'error');
                    setProcessing(false);
                }
            }
        }
        
        function handleApply() {
            if (!currentPlan) {
                showMessage('No plan available to apply. Parse a prompt first.', 'error');
                return;
            }
            
            if (!confirm('Apply this plan to your active design? This action cannot be undone.')) {
                return;
            }
            
            setProcessing(true, 'Applying operations...');
            
            try {
                adsk.fusionSendData('apply', JSON.stringify({ action: 'apply', plan: currentPlan }));
            } catch (e) {
                if (window.fusionJavaScriptHandler && typeof window.fusionJavaScriptHandler.handle === 'function') {
                    try { window.fusionJavaScriptHandler.handle('apply', JSON.stringify({ action: 'apply', plan: currentPlan })); }
                    catch (err) { console.error('Legacy apply failed', err); showMessage('Bridge error (legacy).', 'error'); setProcessing(false); }
                } else {
                    showMessage('Fusion bridge not available.', 'error');
                    setProcessing(false);
                }
            }
        }
        
        function setProcessing(processing, message = '') {
            isProcessing = processing;
            parseBtn.disabled = processing;
            previewBtn.disabled = processing || !currentPlan;
            applyBtn.disabled = processing || !currentPlan;
            
            if (processing) {
                loadingSpinner.style.display = 'inline-block';
                statusText.textContent = message;
            } else {
                loadingSpinner.style.display = 'none';
                statusText.textContent = 'Ready';
            }
        }
        
        function handlePing() {
            try {
                adsk.fusionSendData('ping', JSON.stringify({ action: 'ping' }));
            } catch (e) {
                if (window.fusionJavaScriptHandler && typeof window.fusionJavaScriptHandler.handle === 'function') {
                    try { window.fusionJavaScriptHandler.handle('ping', JSON.stringify({ action: 'ping' })); }
                    catch (err) { showMessage('Ping failed (legacy bridge).', 'error'); }
                } else {
                    showMessage('Bridge not available for ping.', 'error');
                }
            }
        }
        
        function showMessage(message, type = 'info') {
            resultsArea.textContent = message;
            addLogEntry(message, type);
        }
        
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const status = document.createElement('div');
            status.className = `log-status ${type === 'error' ? 'error' : type === 'success' ? 'success' : 'pending'}`;
            
            const text = document.createElement('div');
            text.className = 'log-text';
            text.textContent = message;
            
            const time = document.createElement('div');
            time.className = 'log-time';
            time.textContent = new Date().toLocaleTimeString();
            
            entry.appendChild(status);
            entry.appendChild(text);
            entry.appendChild(time);
            
            actionLog.insertBefore(entry, actionLog.firstChild);
            
            // Limit log entries
            while (actionLog.children.length > 20) {
                actionLog.removeChild(actionLog.lastChild);
            }
        }
        
        // Handle messages from Fusion add-in
        function handleFusionMessage(message) {
            try {
                const data = JSON.parse(message);
                
                switch (data.type) {
                    case 'parseResult':
                        handleParseResult(data);
                        break;
                    case 'previewResult':
                        handlePreviewResult(data);
                        break;
                    case 'applyResult':
                        handleApplyResult(data);
                        break;
                    case 'error':
                        showMessage(`Error: ${data.message}`, 'error');
                        setProcessing(false);
                        break;
                    case 'status':
                        statusText.textContent = data.status || 'Ready';
                        break;
                }
            } catch (e) {
                console.error('Failed to parse message from Fusion:', e);
            }
        }
        
        function handleParseResult(data) {
            setProcessing(false);
            
            if (data.success) {
                currentPlan = data.plan;
                previewBtn.disabled = false;
                applyBtn.disabled = false;
                
                const operations = data.plan.operations || [];
                let resultText = `Plan parsed successfully!\n\n`;
                resultText += `Operations (${operations.length}):`;
                
                operations.forEach((op, i) => {
                    resultText += `\n${i + 1}. ${op.op} (${op.op_id})`;
                });
                
                if (data.warnings && data.warnings.length > 0) {
                    resultText += '\n\nWarnings:\n' + data.warnings.join('\n');
                }
                
                resultsArea.textContent = resultText;
                addLogEntry(`Plan parsed: ${operations.length} operations`, 'success');
            } else {
                showMessage(`Parse failed: ${data.error}`, 'error');
            }
        }
        
        function handlePreviewResult(data) {
            setProcessing(false);
            
            if (data.success) {
                let resultText = `Preview completed!\n\n`;
                resultText += `Features to create: ${data.preview_data.estimated_features.length}\n`;
                resultText += `Estimated duration: ${data.preview_duration.toFixed(1)}s\n\n`;
                resultText += 'Features:\n';
                
                data.preview_data.estimated_features.forEach((feature, i) => {
                    resultText += `${i + 1}. ${feature}\n`;
                });
                
                resultsArea.textContent = resultText;
                addLogEntry('Preview generated successfully', 'success');
            } else {
                showMessage(`Preview failed: ${data.error}`, 'error');
            }
        }
        
        function handleApplyResult(data) {
            setProcessing(false);
            
            if (data.success) {
                let resultText = `Operations applied successfully!\n\n`;
                resultText += `Execution time: ${data.execution_duration.toFixed(1)}s\n`;
                resultText += `Features created: ${data.features_created.length}\n\n`;
                
                if (data.features_created.length > 0) {
                    resultText += 'Created features:\n';
                    data.features_created.forEach((feature, i) => {
                        resultText += `${i + 1}. ${feature}\n`;
                    });
                }
                
                resultsArea.textContent = resultText;
                addLogEntry(`Applied ${data.operations_executed} operations`, 'success');
                
                // Reset for next operation
                currentPlan = null;
                previewBtn.disabled = true;
                applyBtn.disabled = true;
                promptInput.value = '';
            } else {
                showMessage(`Apply failed: ${data.error_message}`, 'error');
            }
        }
        
        // Initialize
        addLogEntry('Co-Pilot UI loaded', 'success');
    </script>
</body>
</html>
        